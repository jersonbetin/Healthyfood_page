<!DOCTYPE html>
<html lang="es">

<head>

    <meta charset="utf-8">
    <title>Inicio</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/freelancer.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" type="text/css" href="css/sweetalert.css">
    <style>
    </style>

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="dashboard.html">HEALTHY FOOD</a>
            </div>
            <div class="navbar-buttons navbar-header pull-right" rol="navigation">
                <ul class="nav navbar-nav ace-nav">
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                          Listar <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu text-capitalize">
                          <li><a href="client.html"><i class="fa fa-user"></i> Clientes</a></li>
                          <li><a href="restaurant.html"><i class="fa fa-building"></i> Restaurantes</a></li>
                          <li><a href="diseases.html"><i class="fa fa-medkit"></i> Enfermedades</a></li>
                          <li><a href="ingredient.html"><i class="fa fa-eyedropper"></i> Ingredientes</a></li>
                        </ul>
                    </li>
                    <li class="dropdown nav-info-user">
                      <a id="dLabel" data-target="#" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                          <img src="img/user.png" alt="" class="img-circle nav-user-photo">
                          <span class="user-info">
                            <small id="userFullName"></small>
                          </span>
                          <span class="caret"></span>
                      </a>
                      <ul class="dropdown-menu text-capitalize">
                        <li><a href="#" class="text-nowrap">Jerson Betin</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a id="logout" href="#"><i class="fa fa-sign-out"></i> logout</a></li>
                      </ul>
                    </li>
                </ul>
            </div>

        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="col-lg-3  body-form">
                        <form class="form-horizontal">
                            <label class="f-caption m-s-b">Buscar Cliente</label>
                          <div class="form-group">
                            <label for="firstName" class="pull-left">Nombre:</label>
                            <input type="text" class="form-control" id="firstName">
                          </div>
                          <div class="form-group">
                            <label for="lastName" class="pull-left">Apellido:</label>
                            <input type="text" class="form-control" id="lastName">
                          </div>
                          <div class="form-group">
                            <label for="email" class="pull-left">Email:</label>
                            <input type="text" class="form-control" id="email">
                          </div>
                          <div class="form-group">
                            <div class="pull-left">
                              <button type="submit" id="seach" class="btn btn-default">Buscar</button>
                            </div>
                          </div>
                        </form>
                    </div>
                    <div class="col-lg-9 body-list">
                        <table class="table table-hover m-l-t">
                            <caption class="text-center">Lista De Clientes</caption>
                            <thead>
                                <tr class="headerTable">
                                    <td>NÂ°</td>
                                    <td>Nombre</td>
                                    <td>Email</td>
                                    <td>Telefono</td>
                                    <td>Direccion</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody id="bodyClient">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4">
                        <h3>Localizanos</h3>
                        <p>Colombia<br>Sahagun - Cordoba</p>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Nuestras redes sociales y webs</h3>
                        <ul class="list-inline">
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-facebook"></i></a>
                            </li>
                            <li>
                                <a href="#" cl
                                ass="btn-social btn-outline"><i class="fa fa-fw fa-google-plus"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-twitter"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-linkedin"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-dribbble"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Lineas de contacto</h3>
                        <p>+57 3003532652 .</p>
                        <p>@victor.jarava .</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; healthyFoodApp 2015
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- jQuery -->
    <script src="js/jquery.js"></script>
    <script src="js/sweetalert.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function(){
            $(function(){
                if(localStorage.AccessToken){
                    var obj = JSON.parse(atob(localStorage.AccessToken.split(".")[1]));
                    console.log(obj);
                    var fecha=new Date().getTime()/1000;
                    if(obj.exp<fecha){
                        localStorage.removeItem("AccessToken");
                        window.location.href="index.html";
                    }else{
                        getUser(obj.user);
                        loadAllClient();
                    }
                 }else{
                    window.location.href="index.html";
                 }
             });

            function getUser(admin){
                $.ajax({
                    url:"http://localhost:3000/api/admins/"+admin,
                    method: "get",
                    headers : {
                        Authorization: localStorage.AccessToken
                    },
                    success: function(result){
                        $("#userFullName").text(result.admin.name.first+' '+result.admin.name.last);
                    },
                    error:function(err){
                        console.log(err);
                    }
                });
            };

            $('#logout').click(function(e){
                localStorage.removeItem("AccessToken");
                window.location.href="index.html";
            });


            function loadAllClient(query){
                $.ajax({
                    url:"http://localhost:3000/api/clients?"+query,
                    method: "get",
                    headers : {
                        Authorization: localStorage.AccessToken
                    },
                    success: function(result){
                        console.log(result);
                        var clients = result.clients;
                        var table = "";
                        if(clients.length){
                            for(var i=0; i<clients.length;i++){
                                table+="<tr>";
                                table+="<td><center>"+(i+1)+"</center></td>";
                                table+="<td class='text-capitalize'><center>"+clients[i].name.first+" "+clients[i].name.last+"</center></td>";
                                table+="<td><center>"+clients[i].email+"</center></td>";
                                table+="<td><center>"+clients[i].phone+"</center></td>";
                                table+="<td><center>"+clients[i].address+"</center></td>";
                                table+="<td><center><a class='btn btn-info btn-xs editClient' user='"+clients[i].user+"'>Resumen</a></center></td>";
                                table+="<td><center><a class='btn btn-danger btn-xs removeClient' email='"+clients[i].email+"'>Eliminar</a></center></td>";
                                table+="</tr>";
                            }
                        }else{
                            table+="<tr>";
                            table+="<td colspan='7'><center>No existen clientes</center></td>";
                            table+="</tr>";
                        }
                        document.getElementById("bodyClient").innerHTML= table;
                    },
                    error:function(err){
                        console.log(err);
                    }
                });
            }


            $("#bodyClient").on('click','.removeClient', function(e){
                e.preventDefault();
                var id = $(this).attr("email");
                swal({
                    title: "Are you sure?",
                    text: "You will not be able to recover this client!",
                    type: "error",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Yes, delete it!",
                    closeOnConfirm: true },
                    function(confirm){
                        if(confirm){
                            $.ajax({
                                url:"http://localhost:3000/api/clients/"+id,
                                method: "delete",
                                headers : {
                                    Authorization: localStorage.AccessToken
                                },
                                success:function(result){
                                    console.log(result.status);
                                    loadAllClient();
                                },
                                error:function(err){
                                    console.log(err.status);
                                }
                            });
                        }
                    });
            });

            $("#firstName").blur(function(e){
                var first = $(this).val();
                var last = $("#lastName").val();
                    if(first.trim() != "" || last.trim() != ""){
                        $("#email").attr("readonly", "true");
                    }else{
                        $("#email").removeAttr("readonly");
                    }
            });

            $("#lastName").blur(function(e){
                 var last = $(this).val();
                var first = $("#firstName").val();
                    if(first.trim() != "" || last.trim() != ""){
                        $("#email").attr("readonly", "true");
                    }else{
                        $("#email").removeAttr("readonly");
                    }
            });

            $("#email").blur(function(e){
                var text = $(this).val();
                    if(text.trim() != ""){
                        $("#firstName").attr("readonly", "true");
                        $("#lastName").attr("readonly", "true");
                    }else{
                        $("#firstName").removeAttr("readonly");
                        $("#lastName").removeAttr("readonly");
                    }
            });

            $("#seach").click(function(e){
                e.preventDefault();
                var query = "";
                var first = $("#firstName").val();
                var last = $("#lastName").val();
                var email = $("#email").val();
                if(first.trim() != ""){
                    query = "first="+first+"&";
                }
                if(last.trim() != ""){
                    query += "last="+last+"&";
                }
                if(email.trim() != ""){
                    query += "email="+email;
                }
                loadAllClient(query);
            });

        });

    </script>
</body>
</html>
